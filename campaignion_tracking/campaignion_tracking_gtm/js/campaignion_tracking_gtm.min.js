!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).campaignionTracking={})}(this,function(t){class e{constructor(t,e,n){void 0===e&&(e=window.dataLayer),void 0===n&&(n=!1),this.debug=n,this.dataLayer=e,this.tracker=t,this._context=this.loadFromStorage("context")||{node:{},donation:{currencyCode:null,product:null},webform:{sid:null}},this.printDebug("init"),void 0!==this.tracker?void 0!==this.dataLayer?(this._dispatch=t=>{this.printDebug("campaignion_tracking_gtm","handle_form",t),this.printDebug("campaignion_tracking_gtm","handle_event",t.name,t.data,t.context),this.dispatch(t.name,t.data,t.context)},this.webformSubscription=this.tracker.subscribe("webform",this._dispatch),this.donationSubscription=this.tracker.subscribe("donation",this._dispatch)):this.printDebug("No datalayer found. Doing nothing."):this.printDebug("No TrackerManager found. Doing nothing.")}printDebug(){this.debug&&console.debug("[campaignion_tracking]","(gtm)",...[].slice.call(arguments))}saveToStorage(t,e){void 0===t&&(t="default"),this.tracker.saveToStorage("campaignion_tracking:gtm:",t,e)}loadFromStorage(t){return void 0===t&&(t="default"),this.tracker.loadFromStorage("campaignion_tracking:gtm:",t)}removeFromStorage(t){return void 0===t&&(t="default"),this.tracker.removeFromStorage("campaignion_tracking:gtm:",t)}dispatch(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n={}),"function"==typeof this["handle_"+t]?this["handle_"+t](t,e,n):this.printDebug("no handler for event name:",t)}callChangeHook(t,e,n){return"function"==typeof window.campaignion_tracking_change_msg&&(e=window.campaignion_tracking_change_msg("gtm",t,e,n)),e}updateContext(t){void 0===t&&(t={}),t.donation&&Object.assign(this._context.donation,t.donation),t.node&&Object.assign(this._context.node,t.node),t.webform&&Object.assign(this._context.webform,t.webform),this.saveToStorage("context",this._context)}handle_submission(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);let o={event:"submission",webform:{nid:e.nid||null,sid:e.sid||null,title:e.title||null}};if(o=this.callChangeHook(t,o,this._context),this.dataLayer.push(o),this.printDebug("(event)",o),e.optins.length>0){let n={event:"optin"};for(const t of e.optins)n[t.channel]=t.value;n=this.callChangeHook(t,n,this._context),this.dataLayer.push(n),this.printDebug("(event)",n)}}handle_draftBegin(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);let o={event:"formBegin",webform:{nid:n.node.nid||null,title:n.node.title||null,type:n.node.type||null,completedStep:n.webform.last_completed_step||null}};o=this.callChangeHook(t,o,this._context),this.dataLayer.push(o),this.printDebug("(event)",o)}handle_draftContinue(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);let o={event:"formContinue",webform:{nid:n.node.nid||null,title:n.node.title||null,completedStep:n.webform.last_completed_step||null}};o=this.callChangeHook(t,o,this._context),this.dataLayer.push(o),this.printDebug("(event)",o)}handle_setDonationProduct(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n),e.currencyCode&&(this._context.donation.currencyCode=e.currencyCode,this.saveToStorage("context",this._context));const o=this._context.donation.currencyCode||null,i=e.prevProduct||{},a={event:"addToCart",ecommerce:{add:{products:[e.product||{}]}}};o&&(a.ecommerce.currencyCode=o);let r={addData:a,removeData:{event:"removeFromCart",ecommerce:{remove:{products:[i]}}},pushRemove:Object.prototype.hasOwnProperty.call(i,"price")};r=this.callChangeHook(t,r,this._context),r.pushRemove&&this.dataLayer.push(r.removeData),this.dataLayer.push(r.addData)}handle_checkoutBegin(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);const o=e.currencyCode||this._context.donation.currencyCode||null;let i={event:"checkoutBegin",ecommerce:{checkout:{actionField:{step:1},products:[e.product||this._context.donation.product||{}]}}};o&&(i.ecommerce.currencyCode=o),i=this.callChangeHook(t,i,this._context),this.dataLayer.push(i)}handle_checkoutEnd(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);const o=e.currencyCode||this._context.donation.currencyCode||null;let i={event:"checkoutEnd",ecommerce:{checkout:{actionField:{step:2},products:[e.product||this._context.donation.product||{}]}}};o&&(i.ecommerce.currencyCode=o),i=this.callChangeHook(t,i,this._context),this.dataLayer.push(i)}handle_donationSuccess(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);const o=e.product||this._context.donation.product||{},i=e.currencyCode||this._context.donation.currencyCode||null,a=e.tid||Math.floor(Math.random()*2**64),r=this.loadFromStorage("sentTransactionIDs")||[];if(r.indexOf(a)>=0)return void this.printDebug("(handle)","already sent TID",t,e,n);let c=e.revenue||null;null===c&&(c=parseFloat(o.price||0)*parseInt(o.quantity||1));let s={event:"purchase",ecommerce:{purchase:{actionField:{id:a,revenue:String(c)},products:[o]}}};i&&(s.ecommerce.currencyCode=i),s=this.callChangeHook(t,s,this._context),this.dataLayer.push(s),r.push(a),this.saveToStorage("sentTransactionIDs",r),this.removeFromStorage("context")}}var n={__proto__:null,name:"gtm",GTMTracker:e};const o=!!parseInt(sessionStorage.getItem("campaignion_debug"));window.dataLayer=window.dataLayer||[];const i=window.campaignion_tracking.tracker;t.gtmTracker=null,void 0===i?console.log("No Tracker found"):(t.gtmTracker=new e(i,window.dataLayer,o),window.campaignion_tracking_gtm={tracker:t.gtmTracker}),t.gtm=n});
