!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).campaignionTracking={})}(this,function(t){const e=(t,e)=>{for(const o of["name","price","id","quantity"])if((Object.prototype.hasOwnProperty.call(t,o)||Object.prototype.hasOwnProperty.call(e,o))&&t[o]!==e[o])return!1;return!0};class o{constructor(t,e,o){void 0===e&&(e=window.dataLayer),void 0===o&&(o=!1),this.debug=o,this.dataLayer=e,this.tracker=t,this._context=this.loadFromStorage("context")||{node:{},donation:{currencyCode:null,product:null},webform:{sid:null}},this.printDebug("init"),void 0!==this.tracker?(void 0===this.dataLayer&&this.printDebug("No datalayer found. Doing nothing."),this._dispatch=t=>{this.printDebug("campaignion_tracking_gtm","handle_form",t),this.printDebug("campaignion_tracking_gtm","handle_event",t.name,t.data,t.context),this.dispatch(t.name,t.data,t.context)},this.webformSubscription=this.tracker.subscribe("webform",this._dispatch),this.donationSubscription=this.tracker.subscribe("donation",this._dispatch)):this.printDebug("No TrackerManager found. Doing nothing.")}printDebug(){this.debug&&console.debug("[campaignion_tracking]","(gtm)",...[].slice.call(arguments))}saveToStorage(t,e){void 0===t&&(t="default"),this.tracker.saveToStorage("campaignion_tracking:gtm:",t,e)}loadFromStorage(t){return void 0===t&&(t="default"),this.tracker.loadFromStorage("campaignion_tracking:gtm:",t)}removeFromStorage(t){return void 0===t&&(t="default"),this.tracker.removeFromStorage("campaignion_tracking:gtm:",t)}dispatch(t,e,o){void 0===t&&(t=""),void 0===e&&(e={}),void 0===o&&(o={}),"function"==typeof this["handle_"+t]?this["handle_"+t](t,e,o):this.printDebug("no handler for event name:",t)}callChangeHook(t,e,o){return"function"==typeof window.campaignion_tracking_change_msg&&(e=window.campaignion_tracking_change_msg("gtm",t,e,o)),e}updateContext(t){void 0===t&&(t={}),t.donation&&Object.assign(this._context.donation,t.donation),t.node&&Object.assign(this._context.node,t.node),t.webform&&Object.assign(this._context.webform,t.webform),this.saveToStorage("context",this._context)}handle_submission(t,e,o){this.printDebug("(handle)",t,e,o),this.updateContext(o);let n={event:"submission",webform:{nid:e.nid||null,sid:e.sid||null,title:e.title||null}};if(n=this.callChangeHook(t,n,this._context),this.dataLayer.push(n),this.printDebug("(event)",n),e.optins.length>0){let o={event:"optin"};for(const t of e.optins)o[t.channel]=t.value;o=this.callChangeHook(t,o,this._context),this.dataLayer.push(o),this.printDebug("(event)",o)}}handle_setDonationProduct(t,o,n){this.printDebug("(handle)",t,o,n),this.updateContext(n),o.currencyCode&&(this._context.donation.currencyCode=o.currencyCode);const a=this._context.donation.currencyCode||null,i=this._context.donation.product||{},r={event:"addToCart",ecommerce:{currencyCode:a,add:{products:[o.product||{}]}}};a&&(r.ecommerce.currencyCode=a);let c={addData:r,removeData:{event:"removeFromCart",ecommerce:{remove:{products:[i]}}},pushRemove:Object.prototype.hasOwnProperty.call(i,"price")};c=this.callChangeHook(t,c,this._context);const s=c.addData.ecommerce.add.products[0];e(c.removeData.ecommerce.remove.products[0],s)?this.printDebug("(handle)",t,"same product",o,n):(this._context.donation.product=s,this.saveToStorage("context",this._context),c.pushRemove&&this.dataLayer.push(c.removeData),this.dataLayer.push(c.addData))}handle_checkoutBegin(t,e,o){this.printDebug("(handle)",t,e,o),this.updateContext(o);const n=e.currencyCode||this._context.donation.currencyCode||null;let a={event:"checkoutBegin",ecommerce:{checkout:{actionField:{step:1},products:[e.product||this._context.donation.product||{}]}}};n&&(a.ecommerce.currencyCode=n),a=this.callChangeHook(t,a,this._context),this.dataLayer.push(a)}handle_checkoutEnd(t,e,o){this.printDebug("(handle)",t,e,o),this.updateContext(o);const n=e.currencyCode||this._context.donation.currencyCode||null;let a={event:"checkoutEnd",ecommerce:{checkout:{actionField:{step:2},products:[e.product||this._context.donation.product||{}]}}};n&&(a.ecommerce.currencyCode=n),a=this.callChangeHook(t,a,this._context),this.dataLayer.push(a)}handle_donationSuccess(t,e,o){this.printDebug("(handle)",t,e,o),this.updateContext(o);const n=e.product||this._context.donation.product||{},a=e.currencyCode||this._context.donation.currencyCode||null,i=e.tid||Math.floor(Math.random()*2**64),r=this.loadFromStorage("sentTransactionIDs")||[];if(r.indexOf(i)>=0)return void this.printDebug("(handle)","already sent TID",t,e,o);let c=e.revenue||null;null===c&&(c=parseFloat(n.price||0)*parseInt(n.quantity||1));let s={event:"purchase",ecommerce:{purchase:{actionField:{id:i,revenue:String(c)},products:[n]}}};a&&(s.ecommerce.currencyCode=a),s=this.callChangeHook(t,s,this._context),this.dataLayer.push(s),r.push(i),this.saveToStorage("sentTransactionIDs",r),this.removeFromStorage("context")}}var n={__proto__:null,name:"gtm",codes:{ds:"donationSuccess",s:"submission"},productIsEqual:e,GTMTracker:o};const a=!!parseInt(sessionStorage.getItem("campaignion_debug"));window.dataLayer=window.dataLayer||[];const i=window.campaignion_tracking.tracker;t.gtmTracker=null,void 0===i?console.log("No Tracker found"):(t.gtmTracker=new o(i,window.dataLayer,a),window.campaignion_tracking_gtm={tracker:t.gtmTracker}),t.gtm=n});
