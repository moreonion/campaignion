!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).campaignionTracking={})}(this,function(t){const e=(t,e)=>{for(const n of["name","price","id","quantity"])if((Object.prototype.hasOwnProperty.call(t,n)||Object.prototype.hasOwnProperty.call(e,n))&&t[n]!==e[n])return!1;return!0};class n{constructor(t,e,n){void 0===e&&(e=window.dataLayer),void 0===n&&(n=!1),this.debug=n,this.dataLayer=e,this.tracker=t,this._context=this.loadFromStorage("context")||{node:{},donation:{currencyCode:null,product:null},webform:{sid:null}},this.printDebug("init"),void 0!==this.tracker?(void 0===this.dataLayer&&this.printDebug("No datalayer found. Doing nothing."),this._dispatch=t=>{this.printDebug("campaignion_tracking_ga4","handle_form",t),this.printDebug("campaignion_tracking_ga4","handle_event",t.name,t.data,t.context),this.dispatch(t.name,t.data,t.context)},this.webformSubscription=this.tracker.subscribe("webform",this._dispatch),this.donationSubscription=this.tracker.subscribe("donation",this._dispatch)):this.printDebug("No TrackerManager found. Doing nothing.")}printDebug(){this.debug&&console.debug("[campaignion_tracking]","(ga4)",...[].slice.call(arguments))}saveToStorage(t,e){void 0===t&&(t="default"),this.tracker.saveToStorage("campaignion_tracking:ga4:",t,e)}loadFromStorage(t){return void 0===t&&(t="default"),this.tracker.loadFromStorage("campaignion_tracking:ga4:",t)}removeFromStorage(t){return void 0===t&&(t="default"),this.tracker.removeFromStorage("campaignion_tracking:ga4:",t)}dispatch(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n={}),"function"==typeof this["handle_"+t]?this["handle_"+t](t,e,n):this.printDebug("no handler for event name:",t)}callChangeHook(t,e,n){return"function"==typeof window.campaignion_tracking_change_msg&&(e=window.campaignion_tracking_change_msg("ga4",t,e,n)),e}updateContext(t){void 0===t&&(t={}),t.donation&&Object.assign(this._context.donation,t.donation),t.node&&Object.assign(this._context.node,t.node),t.webform&&Object.assign(this._context.webform,t.webform),this.saveToStorage("context",this._context)}handle_submission(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);let a={event:"submission",params:{nid:e.nid||null,sid:e.sid||null,title:e.title||null}};if(a=this.callChangeHook(t,a,this._context),this.dataLayer.push(["event",a.event,a.params]),this.printDebug("(event)",a),e.optins.length>0){let n={event:"optin",params:{}};for(const t of e.optins)n.params[t.channel]=t.value;n=this.callChangeHook(t,n,this._context),this.dataLayer.push(["event",n.event,n.params]),this.printDebug("(event)",n)}}handle_draftBegin(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);let a={event:"begin_form",params:{nid:n.node.nid||null,title:n.node.title||null,type:n.node.type||null,completedStep:n.webform.last_completed_step||null}};a=this.callChangeHook(t,a,this._context),this.dataLayer.push(["event",a.event,a.params]),this.printDebug("(event)",a)}handle_draftContinue(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);let a={event:"continue_form",params:{nid:n.node.nid||null,title:n.node.title||null,completedStep:n.webform.last_completed_step||null}};a=this.callChangeHook(t,a,this._context),this.dataLayer.push(["event",a.event,a.params]),this.printDebug("(event)",a)}handle_setDonationProduct(t,n,a){this.printDebug("(handle)",t,n,a),this.updateContext(a),n.currencyCode&&(this._context.donation.currencyCode=n.currencyCode);const i=this._context.donation.currencyCode||null,o=this._context.donation.product||{},r=this._context.donation.revenue||{},s=n.product||{};let d={addData:{event:"add_to_cart",params:{currency:i,value:n.revenue||parseFloat(s.price||0)*parseInt(s.quantity||1),items:[{item_name:null==s?void 0:s.name,item_id:null==s?void 0:s.id,price:null==s?void 0:s.price,item_variant:null==s?void 0:s.variant,quantity:null==s?void 0:s.quantity}]}},removeData:{event:"remove_from_cart",params:{currency:i,value:r,items:[{item_name:null==o?void 0:o.name,item_id:null==o?void 0:o.id,price:null==o?void 0:o.price,item_variant:null==o?void 0:o.variant,quantity:null==o?void 0:o.quantity}]}},pushRemove:Object.prototype.hasOwnProperty.call(o,"price")};d=this.callChangeHook(t,d,this._context);const c=d.addData.params.items[0];e(d.removeData.params.items[0],c)?this.printDebug("(handle)",t,"same product",n,a):(this._context.donation.product=c,this._context.donation.revenue=d.addData.params.value,this.saveToStorage("context",this._context),d.pushRemove&&this.dataLayer.push(["event",d.removeData.event,d.removeData.params]),this.dataLayer.push(["event",d.addData.event,d.addData.params]))}handle_checkoutBegin(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);const a=e.product||this._context.donation.product||{},i=e.currencyCode||this._context.donation.currencyCode||null;let o=e.revenue||this._context.donation.revenue||null;null===o&&(o=parseFloat(a.price||0)*parseInt(a.quantity||1));let r={event:"begin_checkout",params:{currency:i,value:o,items:[{item_name:null==a?void 0:a.name,item_id:null==a?void 0:a.id,price:null==a?void 0:a.price,item_variant:null==a?void 0:a.variant,quantity:null==a?void 0:a.quantity}]}};r=this.callChangeHook(t,r,this._context),this.dataLayer.push(["event",r.event,r.params])}handle_checkoutEnd(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);const a=e.product||this._context.donation.product||{},i=e.currencyCode||this._context.donation.currencyCode||null;let o=e.revenue||this._context.donation.revenue||null;null===o&&(o=parseFloat(a.price||0)*parseInt(a.quantity||1));let r={event:"add_shipping_info",params:{currency:i,value:o,items:[{item_name:null==a?void 0:a.name,item_id:null==a?void 0:a.id,price:null==a?void 0:a.price,item_variant:null==a?void 0:a.variant,quantity:null==a?void 0:a.quantity}]}};r=this.callChangeHook(t,r,this._context),this.dataLayer.push(["event",r.event,r.params])}handle_donationSuccess(t,e,n){this.printDebug("(handle)",t,e,n),this.updateContext(n);const a=e.product||this._context.donation.product||{},i=e.currencyCode||this._context.donation.currencyCode||null,o=e.tid||Math.floor(Math.random()*2**64),r=this.loadFromStorage("sentTransactionIDs")||[];if(r.indexOf(o)>=0)return void this.printDebug("(handle)","already sent TID",t,e,n);let s=e.revenue||this._context.donation.revenue||null;null===s&&(s=parseFloat(a.price||0)*parseInt(a.quantity||1));let d={event:"purchase",params:{transaction_id:o,currency:i,value:s,items:[{item_name:null==a?void 0:a.name,item_id:null==a?void 0:a.id,price:null==a?void 0:a.price,item_variant:null==a?void 0:a.variant,quantity:null==a?void 0:a.quantity}]}};d=this.callChangeHook(t,d,this._context),this.dataLayer.push(["event",d.event,d.params]),r.push(o),this.saveToStorage("sentTransactionIDs",r),this.removeFromStorage("context")}}var a={__proto__:null,name:"ga4",codes:{ds:"donationSuccess",s:"submission"},productIsEqual:e,GA4Tracker:n};const i=!!parseInt(sessionStorage.getItem("campaignion_debug"));window.dataLayer=window.dataLayer||[];const o=window.campaignion_tracking.tracker;t.ga4Tracker=null,void 0===o?console.log("No Tracker found"):(t.ga4Tracker=new n(o,window.dataLayer,i),window.campaignion_tracking_ga4={tracker:t.ga4Tracker}),t.ga4=a});
