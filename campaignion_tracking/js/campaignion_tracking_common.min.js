!function(i,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((i||self).campaignionTracking={})}(this,function(i){function e(i){return void 0===i&&(i=""),i.split(";").filter(Boolean).reduce((i,e)=>{const t=e.indexOf(":"),n=e.substring(0,t),s=e.substring(t+1);return i.concat(o(s,n))},[])}function t(i,t){void 0===i&&(i=[]),void 0===t&&(t="");const n=e(t).reduce((e,t)=>(i.includes(t.prefix)?e.items.push(t):e.rest.push(t.origPart),e),{items:[],rest:[]});return n.origLocationHash=t,n.locationHash=n.rest.join(";"),n}function n(i){const e=i.indexOf("=");return{id:i.substring(0,e),codes:decodeURIComponent(i.substring(e+1)).split(","),origPart:i}}function o(i,e){return void 0===e&&(e=""),i.split("&").map(i=>{const t=n(i);return t.prefix=e,t})}var s={__proto__:null,parseLocationHash:e,parseLocationHashForPrefixes:function(i,t){return void 0===i&&(i=[]),void 0===t&&(t=""),e(t).filter(e=>i.includes(e.prefix))},consumeLocationHashForPrefixes:t,parsePart:n,parsePartsWithPrefix:o};class r{constructor(i,e,t){void 0===e&&(e=[]),void 0===t&&(t=!1),this.debug=t,this.tracker=i,this.prefixes=e,this.printDebug("init"),void 0===this.tracker&&this.printDebug("No TrackerManager found. Doing nothing.")}printDebug(){this.debug&&console.debug("[campaignion_tracking]","(listener)",...[].slice.call(arguments))}setup(){window.addEventListener("load",i=>{const e=window.location.hash.substring(1),n=t(this.prefixes,e);n.locationHash!==e&&(n.locationHash.length?window.location.hash="#"+n.locationHash:window.history.replaceState("",window.document.title,window.location.pathname+window.location.search),this.tracker.publish("code",n))})}}var a={__proto__:null,FragmentListener:r};class c{constructor(i){void 0===i&&(i=!1),this.debug=i,this.topics={},this.printDebug("init")}printDebug(){this.debug&&console.debug("[campaignion_tracking]",...[].slice.call(arguments))}subscribe(i,e){this.printDebug("subscribe",e),this.topics[i]||(this.topics[i]=[]);const t=this.topics[i].push(e)-1;return{remove:()=>{delete this.topics[t]}}}publish(i,e){if(void 0===e&&(e={}),this.printDebug("publish",e),this.topics[i])for(const t of this.topics[i])t(e)}saveToStorage(i,e,t){void 0===i&&(i="campaignion_tracking:"),void 0===e&&(e="default"),window.sessionStorage.setItem(i+e,JSON.stringify(t))}loadFromStorage(i,e){return void 0===i&&(i="campaignion_tracking:"),void 0===e&&(e="default"),JSON.parse(window.sessionStorage.getItem(i+e))}removeFromStorage(i,e){void 0===i&&(i="campaignion_tracking:"),void 0===e&&(e="default"),window.sessionStorage.removeItem(i+e)}}var d={__proto__:null,TrackerManager:c};const u={ds:"donationSuccess",s:"submission"},l=!!parseInt(sessionStorage.getItem("campaignion_debug")),p=function(){l&&console.debug("[campaignion_tracking]","(drupal)",...[].slice.call(arguments))},g=["t","w","d"],h=new c(l),f=new r(h,g,l);f.setup();const m=h.subscribe("code",i=>{p("handle_code",i);const e=/optin\[(\w+)\]/,t=i.items.reduce((i,t)=>{if("t"===t.prefix&&"t"===t.id&&t.codes.forEach(e=>{u[e]&&i.tracking.events.push(u[e])}),"w"===t.prefix&&("nid"===t.id&&(i.webform.nid=t.codes[0]),"sid"===t.id&&(i.webform.sid=t.codes[0]),"title"===t.id&&(i.webform.title=t.codes[0]),"optin"===t.id.substring(0,5))){const n=e.exec(t.id);n[1]&&i.optins.push({channel:n[1],value:t.codes[0]})}return"d"===t.prefix&&"m"===t.id&&(i.donation.method=t.codes[0]),i},{tracking:{events:[]},webform:{},donation:{},optins:[]});p("handle_events",t);const n={webform:{sid:t.webform.sid||null},donation:{paymethod:t.donation.method||"unknown"}};t.tracking.events.includes("donationSuccess")&&h.publish("donation",{name:"donationSuccess",data:{tid:t.webform.sid||null},context:n}),t.tracking.events.includes("submission")&&h.publish("webform",{name:"submission",data:{nid:t.webform.nid||null,sid:t.webform.sid||null,title:t.webform.title||null,optins:t.optins||[]},context:n})});window.campaignion_tracking={tracker:h},i.codePrefixes=g,i.codeSubscription=m,i.debug=l,i.fragment=s,i.fragmentListener=f,i.listener=a,i.tm=d,i.tracker=h,i.trackingCodes=u});
